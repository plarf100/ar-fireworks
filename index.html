<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¥¿æ—ºå¼€å…ƒå•†åŸé€æ‚¨çš„èµ›åšçƒŸèŠ±ç››å®´</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            text-align: center;
            padding: 8px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 50%, #ffd700 100%);
            font-weight: bold;
            font-size: 14px;
            z-index: 100;
            line-height: 1.3;
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.4);
            position: relative;
        }

        /* æ‘„åƒå¤´å®¹å™¨ */
        #camera-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ‘„åƒå¤´è§†é¢‘ - æœ€åº•å±‚ï¼Œæ²¡æœ‰ä»»ä½•èƒŒæ™¯ */
        #camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 1;
            display: none; /* åˆå§‹éšè— */
            background: #000; /* çº¯é»‘è‰²èƒŒæ™¯ï¼Œæ— ä»»ä½•è’™ç‰ˆ */
        }

        /* çƒŸèŠ±Canvas - æœ€ä¸Šå±‚ï¼Œé€æ˜èƒŒæ™¯ */
        #fireworks-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
            pointer-events: auto; /* ç¡®ä¿èƒ½æ¥æ”¶ç‚¹å‡» */
            background: transparent; /* å®Œå…¨é€æ˜ï¼Œä¸è¦†ç›–æ‘„åƒå¤´ */
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: absolute;
            top: 50px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 20;
            display: none;
            backdrop-filter: blur(5px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4cd964;
            display: inline-block;
            margin-right: 5px;
            animation: blink 1s infinite;
        }

        .status-dot.error {
            background: #ff3b30;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            z-index: 20;
            border-radius: 8px;
            margin: 0 15px;
            line-height: 1.4;
            backdrop-filter: blur(5px);
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            background: rgba(10, 15, 30, 0.95);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2575fc;
            color: #2575fc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff3838);
        }

        .btn-success {
            background: linear-gradient(135deg, #00c853, #64dd17);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 10px;
        }

        /* çƒŸèŠ±ç±»å‹é€‰æ‹©å™¨ - ç¾åŒ–æ»‘å— */
        .firework-selector-container {
            position: relative;
            width: 200px;
            height: 40px;
            overflow: hidden;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .firework-selector {
            display: flex;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
            scroll-behavior: smooth;
        }

        .firework-selector::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .firework-type {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 14px;
            flex-shrink: 0;
            margin: 0 2px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            user-select: none;
        }

        .firework-type:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        .firework-type.active {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.15);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* æ»‘åŠ¨æç¤ºç®­å¤´ */
        .scroll-hint {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.5), transparent);
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .scroll-hint.left {
            left: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.5), transparent);
        }

        .scroll-hint.right {
            right: 0;
            background: linear-gradient(to left, rgba(0,0,0,0.5), transparent);
        }

        .firework-selector-container:hover .scroll-hint {
            opacity: 1;
        }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            text-align: center;
            max-width: 80%;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            opacity: 1;
        }

        /* å¼•å¯¼ç•Œé¢ */
        .onboarding {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(20, 20, 40, 0.95);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            z-index: 50;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .onboarding h3 {
            margin-bottom: 10px;
            color: #ff6b6b;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .onboarding p {
            font-size: 12px;
            margin-bottom: 15px;
            line-height: 1.5;
            text-align: left;
            color: #ddd;
        }

        .onboarding .btn {
            width: 100%;
            margin-bottom: 8px;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            z-index: 5;
            display: none;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ‹ç…§æŒ‰é’® */
        .photo-btn {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 15;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            user-select: none;
        }

        .photo-btn:active {
            transform: translateX(-50%) scale(0.9);
        }

        .photo-btn::before {
            content: 'ğŸ“¸';
            font-size: 28px;
        }

        /* æ‹ç…§ç»“æœé¢„è§ˆ */
        .photo-preview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .photo-preview img {
            max-width: 90%;
            max-height: 70%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .photo-preview .preview-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        /* éŸ³æ•ˆåˆ‡æ¢æŒ‰é’® */
        .sound-toggle {
            position: absolute;
            top: 60px;
            left: 15px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            font-size: 18px;
            transition: all 0.2s;
            user-select: none;
        }

        .sound-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .sound-toggle.muted {
            opacity: 0.5;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .header { font-size: 13px; padding: 6px; }
            .btn { padding: 6px 8px; font-size: 10px; }
            .firework-type { width: 36px; height: 36px; font-size: 12px; }
            .instruction { font-size: 11px; top: 12px; padding: 6px; }
            .onboarding { padding: 12px; width: 90%; }
            .status-indicator { top: 45px; font-size: 10px; padding: 4px 8px; }
            .photo-btn { width: 50px; height: 50px; bottom: 75px; }
            .photo-btn::before { font-size: 24px; }
            .firework-selector-container { width: 160px; }
            .sound-toggle { width: 35px; height: 35px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">âœ¨ è¥¿æ—ºå¼€å…ƒå•†åŸé€æ‚¨çš„èµ›åšçƒŸèŠ±ç››å®´  âœ¨</div>

    <div id="camera-container">
        <!-- æ‘„åƒå¤´è§†é¢‘ - æœ€åº•å±‚ï¼Œæ²¡æœ‰ä»»ä½•èƒŒæ™¯ -->
        <video id="camera-video" autoplay playsinline muted webkit-playsinline></video>

        <!-- çƒŸèŠ±Canvas - æœ€ä¸Šå±‚ï¼Œå®Œå…¨é€æ˜ -->
        <canvas id="fireworks-canvas"></canvas>

        <!-- éŸ³æ•ˆåˆ‡æ¢ -->
        <div class="sound-toggle" id="sound-toggle" title="éŸ³æ•ˆå¼€å…³">ğŸ”Š</div>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status-indicator" id="status-indicator">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">ç­‰å¾…å¯åŠ¨...</span>
        </div>

        <!-- æç¤ºæ–‡å­— -->
        <div class="instruction" id="instruction-text">
            ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"æˆæƒæƒé™<br>
            <small>æˆ–ç›´æ¥ç‚¹å‡»å±å¹•æ”¾çƒŸèŠ±</small>
        </div>

        <!-- æ‹ç…§æŒ‰é’® -->
        <div class="photo-btn" id="photo-btn" title="æ‹ç…§ä¿å­˜"></div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div id="loading-text">æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...</div>
        </div>

        <!-- å¼•å¯¼ç•Œé¢ -->
        <div class="onboarding" id="onboarding">
            <h3>ğŸ† èµ›åšçƒŸèŠ±ç››å®´</h3>
            <p>1. ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"æˆæƒæƒé™<br>
            2. æ‘„åƒå¤´ç”»é¢å°†æ˜¾ç¤ºåœ¨èƒŒæ™¯<br>
            3. ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ”¾çƒŸèŠ±<br>
            4. ç‚¹å‡»ğŸ“·æŒ‰é’®æ‹ç…§ä¿å­˜çƒŸèŠ±ç…§ç‰‡<br>
            5. ğŸ”ŠæŒ‰é’®åˆ‡æ¢éŸ³æ•ˆå¼€å…³</p>
            <button class="btn" id="start-btn">å¯åŠ¨æ‘„åƒå¤´</button>
            <button class="btn btn-outline" id="skip-btn">è·³è¿‡æ‘„åƒå¤´</button>
            <button class="btn btn-outline" id="help-btn">ä½¿ç”¨å¸®åŠ©</button>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-outline btn-small" id="qr-btn">ğŸ“± åˆ†äº«</button>

        <!--ç¾åŒ–åçš„çƒŸèŠ±é€‰æ‹©å™¨ -->
        <div class="firework-selector-container">
            <div class="scroll-hint left">â—€</div>
            <div class="firework-selector" id="firework-selector">
                <!-- çƒŸèŠ±ç±»å‹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div class="scroll-hint right">â–¶</div>
        </div>

        <button class="btn btn-danger btn-small" id="clear-btn">ğŸ† æ¸…é™¤</button>
    </div>

    <!-- æ‹ç…§é¢„è§ˆç•Œé¢ -->
    <div class="photo-preview" id="photo-preview">
        <img id="preview-image" src="" alt="çƒŸèŠ±ç…§ç‰‡">
        <div class="preview-controls">
            <button class="btn btn-success" id="save-photo-btn">ä¿å­˜ç…§ç‰‡</button>
            <button class="btn btn-outline" id="close-preview-btn">å…³é—­</button>
        </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // è·å–DOMå…ƒç´ 
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('camera-container');
        const instruction = document.getElementById('instruction-text');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const onboarding = document.getElementById('onboarding');
        const startBtn = document.getElementById('start-btn');
        const skipBtn = document.getElementById('skip-btn');
        const helpBtn = document.getElementById('help-btn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const toast = document.getElementById('toast');
        const qrBtn = document.getElementById('qr-btn');
        const clearBtn = document.getElementById('clear-btn');
        const photoBtn = document.getElementById('photo-btn');
        const fireworkSelector = document.getElementById('firework-selector');
        const photoPreview = document.getElementById('photo-preview');
        const previewImage = document.getElementById('preview-image');
        const savePhotoBtn = document.getElementById('save-photo-btn');
        const closePreviewBtn = document.getElementById('close-preview-btn');
        const soundToggle = document.getElementById('sound-toggle');

        // çŠ¶æ€å˜é‡
        let cameraActive = false;
        let cameraStream = null;
        let fireworks = [];
        let particles = [];
        let lastClickTime = 0;
        let currentType = 'color';
        let soundEnabled = true;

        // éŸ³æ•ˆä¸Šä¸‹æ–‡
        let audioContext = null;

        // çƒŸèŠ±ç±»å‹é…ç½® - ä¸°å¯Œæ ·å¼
        const fireworkTypes = {
            color: {
                colors: ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'],
                name: 'å½©è™¹',
                icon: 'ğŸŒˆ'
            },
            gold: {
                colors: ['#FFD700', '#FFA500', '#FF8C00', '#FF7800', '#FF6700', '#FFE4B5', '#F0E68C'],
                name: 'é»„é‡‘',
                icon: 'ğŸŒŸ'
            },
            purple: {
                colors: ['#8A2BE2', '#9370DB', '#9932CC', '#BA55D3', '#DA70D6', '#EE82EE', '#DDA0DD'],
                name: 'ç´«è‰²',
                icon: 'ğŸ’œ'
            },
            heart: {
                colors: ['#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB', '#FF69B4'],
                shape: 'heart',
                name: 'çˆ±å¿ƒ',
                icon: 'â¤'
            },
            spiral: {
                colors: ['#00FF00', '#32CD32', '#00FA9A', '#90EE90'],
                shape: 'spiral',
                name: 'èºæ—‹',
                icon: 'ğŸŒ€'
            },
            star: {
                colors: ['#FFD700', '#FFA500', '#FF6347', '#FF4500'],
                shape: 'star',
                name: 'æ˜Ÿæ˜Ÿ',
                icon: 'â­'
            },
            circle: {
                colors: ['#00FFFF', '#00BFFF', '#1E90FF', '#4169E1'],
                shape: 'circle',
                name: 'åœ†ç¯',
                icon: 'â­•'
            },
            diamond: {
                colors: ['#FF00FF', '#FF1493', '#DA70D6', '#EE82EE'],
                shape: 'diamond',
                name: 'é’»çŸ³',
                icon: 'ğŸ’'
            },
            rainbow: {
                colors: ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'],
                shape: 'rainbow',
                name: 'ä¸ƒå½©',
                icon: 'ğŸŒˆ'
            },
            fire: {
                colors: ['#FF4500', '#FF6347', '#FFD700', '#FFA500'],
                shape: 'fire',
                name: 'ç«ç„°',
                icon: 'ğŸ”¥'
            },
            ice: {
                colors: ['#00CED1', '#48D1CC', '#40E0D0', '#7FFFD4'],
                shape: 'ice',
                name: 'å†°æ™¶',
                icon: 'â„ï¸'
            },
            galaxy: {
                colors: ['#8A2BE2', '#4B0082', '#9370DB', '#BA55D3', '#00CED1', '#48D1CC'],
                shape: 'galaxy',
                name: 'é“¶æ²³',
                icon: 'ğŸŒŒ'
            },
            neon: {
                colors: ['#FF00FF', '#00FFFF', '#FFFF00', '#FF00FF'],
                shape: 'neon',
                name: 'éœ“è™¹',
                icon: 'âš¡'
            },
            love: {
                colors: ['#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB', '#FF69B4', '#FF0000'],
                shape: 'heart',
                name: 'çˆ±',
                icon: 'ğŸ’•'
            }
        };

        // åˆå§‹åŒ–
        function init() {
            console.log('åˆå§‹åŒ–å¼€å§‹');
            resizeCanvas();
            bindEvents();
            generateFireworkSelector();
            requestAnimationFrame(animateFireworks);
            showToast('ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±ï¼');
            console.log('åˆå§‹åŒ–å®Œæˆ');
        }

        // è°ƒæ•´Canvaså°ºå¯¸
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // ç”ŸæˆçƒŸèŠ±é€‰æ‹©å™¨
        function generateFireworkSelector() {
            fireworkSelector.innerHTML = '';

            for (const [key, type] of Object.entries(fireworkTypes)) {
                const btn = document.createElement('div');
                btn.className = 'firework-type';
                btn.dataset.type = key;
                btn.dataset.name = type.name;
                btn.textContent = type.icon;
                btn.title = type.name;

                if (key === currentType) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', () => {
                    document.querySelectorAll('.firework-type').forEach(e => e.classList.remove('active'));
                    btn.classList.add('active');
                    currentType = key;
                    showToast(`å·²åˆ‡æ¢åˆ°${type.name}çƒŸèŠ±`);
                });

                fireworkSelector.appendChild(btn);
            }
        }

        // ç»‘å®šäº‹ä»¶ - ç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æœ‰äº‹ä»¶ç›‘å¬
        function bindEvents() {
            console.log('å¼€å§‹ç»‘å®šäº‹ä»¶');

            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', resizeCanvas);

            // å¼€å§‹æ‘„åƒå¤´ - ç¡®ä¿ç»‘å®šæˆåŠŸ
            if (startBtn) {
                startBtn.addEventListener('click', startCamera);
                console.log('å¯åŠ¨æ‘„åƒå¤´æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('å¯åŠ¨æ‘„åƒå¤´æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // è·³è¿‡æ‘„åƒå¤´
            if (skipBtn) {
                skipBtn.addEventListener('click', skipCamera);
                console.log('è·³è¿‡æ‘„åƒå¤´æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('è·³è¿‡æ‘„åƒå¤´æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // å¸®åŠ©æŒ‰é’®
            if (helpBtn) {
                helpBtn.addEventListener('click', showHelp);
                console.log('å¸®åŠ©æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('å¸®åŠ©æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // Canvasç‚¹å‡»äº‹ä»¶ -æ”¯æŒå¤šç‚¹è§¦æ§
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });

            // æ¸…é™¤æŒ‰é’®
            if (clearBtn) {
                clearBtn.addEventListener('click', clearFireworks);
                console.log('æ¸…é™¤æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('æ¸…é™¤æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // åˆ†äº«æŒ‰é’®
            if (qrBtn) {
                qrBtn.addEventListener('click', showShare);
                console.log('åˆ†äº«æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('åˆ†äº«æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // æ‹ç…§æŒ‰é’®
            if (photoBtn) {
                photoBtn.addEventListener('click', takePhoto);
                console.log('æ‹ç…§æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('æ‹ç…§æŒ‰é’®æœªæ‰¾åˆ°');
            }

            // é¢„è§ˆç•Œé¢æŒ‰é’®
            if (savePhotoBtn) {
                savePhotoBtn.addEventListener('click', savePhoto);
                console.log('ä¿å­˜ç…§ç‰‡æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('ä¿å­˜ç…§ç‰‡æŒ‰é’®æœªæ‰¾åˆ°');
            }

            if (closePreviewBtn) {
                closePreviewBtn.addEventListener('click', () => {
                    photoPreview.style.display = 'none';
                });
                console.log('å…³é—­é¢„è§ˆæŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('å…³é—­é¢„è§ˆæŒ‰é’®æœªæ‰¾åˆ°');
            }

            // éŸ³æ•ˆåˆ‡æ¢
            if (soundToggle) {
                soundToggle.addEventListener('click', toggleSound);
                console.log('éŸ³æ•ˆåˆ‡æ¢æŒ‰é’®ç»‘å®šæˆåŠŸ');
            } else {
                console.error('éŸ³æ•ˆåˆ‡æ¢æŒ‰é’®æœªæ‰¾åˆ°');
            }

            console.log('äº‹ä»¶ç»‘å®šå®Œæˆ');
        }

        // åˆå§‹åŒ–éŸ³æ•ˆä¸Šä¸‹æ–‡
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('éŸ³æ•ˆä¸Šä¸‹æ–‡åˆå§‹åŒ–æˆåŠŸ');
                } catch (e) {
                    console.log('éŸ³æ•ˆä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±è´¥:', e);
                    soundEnabled = false;
                    soundToggle.classList.add('muted');
                }
            }
        }

        // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ
        function playExplosionSound() {
            if (!soundEnabled || !audioContext) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                //çˆ†ç‚¸éŸ³æ•ˆå‚æ•°
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }

        // æ’­æ”¾å‘å°„éŸ³æ•ˆ
        function playLaunchSound() {
            if (!soundEnabled || !audioContext) return;

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // å‘å°„éŸ³æ•ˆå‚æ•°
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.2);

                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢éŸ³æ•ˆ
        function toggleSound() {
            soundEnabled = !soundEnabled;

            if (soundEnabled) {
                soundToggle.textContent = 'ğŸ”Š';
                soundToggle.classList.remove('muted');
                showToast('éŸ³æ•ˆå·²å¼€å¯');
                initAudioContext();
            } else {
                soundToggle.textContent = 'ğŸ”‡';
                soundToggle.classList.add('muted');
                showToast('éŸ³æ•ˆå·²å…³é—­');
            }
        }

        // å¯åŠ¨æ‘„åƒå¤´ - å¢å¼ºç‰ˆ
        async function startCamera() {
            console.log('å¯åŠ¨æ‘„åƒå¤´æŒ‰é’®è¢«ç‚¹å‡»');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            loadingText.textContent = 'æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...';
            statusIndicator.style.display = 'flex';
            statusText.textContent = 'æ­£åœ¨å¯åŠ¨...';

            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½');
                }

                // æ£€æŸ¥HTTPSç¯å¢ƒ
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    showToast('å»ºè®®ä½¿ç”¨HTTPSç¯å¢ƒä»¥ç¡®ä¿æ‘„åƒå¤´åŠŸèƒ½æ­£å¸¸');
                }

                // è¯·æ±‚æ‘„åƒå¤´æƒé™
                const constraints = {
                    video: {
                        facingMode: 'environment', // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;

                // ç­‰å¾…è§†é¢‘åŠ è½½
                video.onloadedmetadata = async () => {
                    try {
                        // å°è¯•æ’­æ”¾è§†é¢‘
                        await video.play();

                        // æˆåŠŸï¼æ˜¾ç¤ºè§†é¢‘
                        video.style.display = 'block';
                        cameraActive = true;

                        // æ›´æ–°UI
                        loading.style.display = 'none';
                        statusDot.classList.remove('error');
                        statusText.textContent = 'æ‘„åƒå¤´å·²å¯ç”¨';
                        instruction.innerHTML = 'ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ”¾çƒŸèŠ±<br><small>çƒŸèŠ±å°†å åŠ åœ¨å®æ™¯ç”»é¢ä¸Š</small>';
                        onboarding.style.display = 'none';

                        showToast('æ‘„åƒå¤´å·²å¯ç”¨ï¼ç°åœ¨ç‚¹å‡»å±å¹•æ”¾çƒŸèŠ±');

                    } catch (playError) {
                        throw new Error('æ‘„åƒå¤´æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                    }
                };

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                // æ›´æ–°UIæ˜¾ç¤ºé”™è¯¯
                loading.style.display = 'none';
                statusDot.classList.add('error');
                statusText.textContent = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥';

                // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºä¸åŒæç¤º
                let errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–åº”ç”¨åé‡è¯•';
                } else if (error.message.includes('HTTPS')) {
                    errorMessage = 'è¯·ä½¿ç”¨HTTPSé“¾æ¥è®¿é—®ï¼ˆåœ°å€æ åº”æœ‰ğŸ”’å›¾æ ‡ï¼‰';
                } else {
                    errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œä½†çƒŸèŠ±æ•ˆæœä»å¯ä½¿ç”¨';
                }

                showToast(errorMessage);

                // 2ç§’åè‡ªåŠ¨è·³è¿‡
                setTimeout(() => {
                    if (!cameraActive) {
                        skipCamera();
                    }
                }, 2000);
            }
        }

        // è·³è¿‡æ‘„åƒå¤´
        function skipCamera() {
            console.log('è·³è¿‡æ‘„åƒå¤´æŒ‰é’®è¢«ç‚¹å‡»');

            cameraActive = false;
            loading.style.display = 'none';
            statusDot.classList.add('error');
            statusText.textContent = 'ä½¿ç”¨èƒŒæ™¯æ¨¡å¼';
            instruction.innerHTML = 'ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±<br><small>ä½¿ç”¨èƒŒæ™¯æ¨¡å¼</small>';
            onboarding.style.display = 'none';

            // éšè—æ‘„åƒå¤´ï¼Œæ˜¾ç¤ºé»‘è‰²èƒŒæ™¯
            video.style.display = 'none';

            showToast('ä½¿ç”¨é»‘è‰²èƒŒæ™¯æ¨¡å¼');
        }

        // æ˜¾ç¤ºå¸®åŠ©
        function showHelp() {
            console.log('å¸®åŠ©æŒ‰é’®è¢«ç‚¹å‡»');

            const helpText = `
                <h3>ä½¿ç”¨å¸®åŠ©</h3>
                <p style="text-align: left; font-size: 12px; line-height: 1.6;">
                    <strong>ç›¸æœºæ— æ³•ä½¿ç”¨ï¼Ÿ</strong><br>
                    1. ç¡®ä¿ä½¿ç”¨HTTPSé“¾æ¥ï¼ˆåœ°å€æ æœ‰ğŸ”’ï¼‰<br>
                    2. åœ¨æ‰‹æœºè®¾ç½®ä¸­æˆäºˆæµè§ˆå™¨æ‘„åƒå¤´æƒé™<br>
                    3. å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨<br>
                    4. é‡å¯æ‰‹æœºåé‡è¯•<br><br>
                    <strong>æ‹ç…§åŠŸèƒ½ï¼š</strong><br>
                    ç‚¹å‡»ğŸ“·æŒ‰é’®å³å¯ä¿å­˜çƒŸèŠ±ç…§ç‰‡<br><br>
                    <strong>éŸ³æ•ˆåŠŸèƒ½ï¼š</strong><br>
                    ğŸ”ŠæŒ‰é’®å¯å¼€å¯/å…³é—­çˆ†ç‚¸éŸ³æ•ˆ
                </p>
            `;

            const helpModal = document.createElement('div');
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 200;
                padding: 20px;
            `;

            helpModal.innerHTML = `
                <div style="background: rgba(20, 20, 40, 0.95); padding: 20px; border-radius: 10px; max-width: 90%; width: 320px; color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                    ${helpText}
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; margin-top: 15px; width: 100%;">å…³é—­</button>
                </div>
            `;

            document.body.appendChild(helpModal);
        }

        // å¤„ç†Canvasç‚¹å‡»
        function handleCanvasClick(e) {
            const now = Date.now();
            if (now - lastClickTime < 300) return; // é˜²æ­¢è¿ç»­ç‚¹å‡»
            lastClickTime = now;

            // è·å–ç‚¹å‡»ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // å‘å°„çƒŸèŠ±
            fire(x, y);
        }

        // å¤„ç†è§¦æ‘¸äº‹ä»¶
        function handleTouchStart(e) {
            e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨

            const now = Date.now();
            if (now - lastClickTime < 200) return; // é˜²æ­¢è¿ç»­ç‚¹å‡»
            lastClickTime = now;

            // å¤„ç†å¤šç‚¹è§¦æ§
            for (let i = 0; i < e.touches.length; i++) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[i];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;

                // å‘å°„çƒŸèŠ±
                fire(x, y);
            }
        }

        // å¤„ç†è§¦æ‘¸ç§»åŠ¨ï¼ˆæ‹–åŠ¨å‘å°„ï¼‰
        function handleTouchMove(e) {
            e.preventDefault();

            const now = Date.now();
            if (now - lastClickTime < 100) return; // é˜²æ­¢è¿‡äºé¢‘ç¹

            //å¤„ç†å¤šç‚¹è§¦æ§
            for (let i = 0; i < e.touches.length; i++) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[i];
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;

                // å‘å°„çƒŸèŠ±
                fire(x, y);
            }
        }

        // å‘å°„çƒŸèŠ± - å…³é”®ä¼˜åŒ–ï¼šä»ç‚¹å‡»å¤„ç«–ç›´å‘ä¸Šå‘å°„
        function fire(x, y) {
            // å…³é”®ä¿®æ”¹ï¼šçƒŸèŠ±ä»ç‚¹å‡»ä½ç½®(x, y)å‘å°„ï¼Œç›®æ ‡ç‚¹åœ¨ç‚¹å‡»ä½ç½®ä¸Šæ–¹
            const startX = x;
            const startY = y;

            // ç›®æ ‡ç‚¹ï¼šç‚¹å‡»ä½ç½®ä¸Šæ–¹ä¸€å®šè·ç¦»ï¼Œç¡®ä¿çƒŸèŠ±å‘ä¸Šå‘å°„
            // æ ¹æ®ç‚¹å‡»ä½ç½®çš„yå€¼è®¡ç®—ç›®æ ‡ç‚¹ï¼Œç¡®ä¿è½¨è¿¹è¶³å¤Ÿé•¿
            const targetY = Math.max(0, y - (container.clientHeight * 0.3)); // å‘ä¸Š30%å±å¹•é«˜åº¦

            // æ’­æ”¾å‘å°„éŸ³æ•ˆ
            playLaunchSound();

            const firework = new Firework(startX, startY, x, targetY, currentType);
            fireworks.push(firework);

            showToast('çƒŸèŠ±å·²å‘å°„ï¼');
        }

        // æ¸…é™¤çƒŸèŠ±
        function clearFireworks() {
            console.log('æ¸…é™¤æŒ‰é’®è¢«ç‚¹å‡»');

            fireworks = [];
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('çƒŸèŠ±å·²æ¸…é™¤');
        }

        // æ‹ç…§åŠŸèƒ½
        function takePhoto() {
            console.log('æ‹ç…§æŒ‰é’®è¢«ç‚¹å‡»');

            try {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶Canvasæ¥ç»„åˆç”»é¢
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                // å¦‚æœæ‘„åƒå¤´å¯ç”¨ï¼Œç»˜åˆ¶æ‘„åƒå¤´ç”»é¢
                if (cameraActive && video.readyState === video.HAVE_ENOUGH_DATA) {
                    // ç»˜åˆ¶è§†é¢‘ï¼ˆé•œåƒç¿»è½¬ï¼‰
                    tempCtx.save();
                    tempCtx.scale(-1, 1);
                    tempCtx.drawImage(video, -tempCanvas.width, 0, tempCanvas.width, tempCanvas.height);
                    tempCtx.restore();
                } else {
                    // ç»˜åˆ¶é»‘è‰²èƒŒæ™¯
                    tempCtx.fillStyle = '#000';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                }

                // ç»˜åˆ¶çƒŸèŠ±
                tempCtx.drawImage(canvas, 0, 0);

                // è½¬æ¢ä¸ºå›¾ç‰‡
                const dataURL = tempCanvas.toDataURL('image/png');

                // æ˜¾ç¤ºé¢„è§ˆ
                previewImage.src = dataURL;
                photoPreview.style.display = 'flex';

                showToast('æ‹ç…§æˆåŠŸï¼ç‚¹å‡»ä¿å­˜ä¿å­˜åˆ°ç›¸å†Œ');

            } catch (error) {
                console.error('æ‹ç…§å¤±è´¥:', error);
                showToast('æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // ä¿å­˜ç…§ç‰‡
        function savePhoto() {
            console.log('ä¿å­˜ç…§ç‰‡æŒ‰é’®è¢«ç‚¹å‡»');

            try {
                const dataURL = previewImage.src;

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = `èµ›åšçƒŸèŠ±_${new Date().getTime()}.png`;
                link.href = dataURL;
                link.click();

                showToast('ç…§ç‰‡å·²ä¿å­˜åˆ°ç›¸å†Œ');
                photoPreview.style.display = 'none';

            } catch (error) {
                console.error('ä¿å­˜ç…§ç‰‡å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æˆªå›¾');
            }
        }

        // æ˜¾ç¤ºåˆ†äº«
        function showShare() {
            console.log('åˆ†äº«æŒ‰é’®è¢«ç‚¹å‡»');

            const currentUrl = window.location.href;
            const qrEmoji = 'ğŸ†';

            const qrModal = document.createElement('div');
            qrModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 200;
                padding: 20px;
            `;

            qrModal.innerHTML = `
                <div style="background: rgba(20, 20, 40, 0.95); padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; width: 300px; border: 1px solid rgba(255,255,255,0.2);">
                    <h2 style="margin: 0 0 15px 0; color: #ff6b6b;">åˆ†äº«èµ›åšçƒŸèŠ±</h2>
                    <div style="width: 200px; height: 200px; background: linear-gradient(45deg, #ff6b6b, #ff8e53); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; border-radius: 10px;">
                        ${qrEmoji}
                    </div>
                    <p style="margin: 0 0 15px 0; font-size: 12px; color: #ccc;">é•¿æŒ‰äºŒç»´ç ä¿å­˜æˆ–åˆ†äº«ç»™æœ‹å‹</p>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #ff6b6b; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer;">å…³é—­</button>
                </div>
            `;

            document.body.appendChild(qrModal);

            showToast('æˆªå›¾åˆ†äº«ç»™æœ‹å‹ï¼');
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            console.log('æ˜¾ç¤ºæç¤º:', message);

            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // çƒŸèŠ±æ¸²æŸ“å¾ªç¯
        function animateFireworks() {
            // å…³é”®ä¿®å¤ï¼šå®Œå…¨æ¸…é™¤Canvasï¼Œä¸ä½¿ç”¨ä»»ä½•åŠé€æ˜èƒŒæ™¯
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const firework = fireworks[i];
                if (!firework.update()) {
                    fireworks.splice(i, 1);
                } else {
                    firework.draw(ctx);
                }
            }

            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                if (!particle.update()) {
                    particles.splice(i, 1);
                } else {
                    particle.draw(ctx);
                }
            }

            requestAnimationFrame(animateFireworks);
        }

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, color, shape = 'circle') {
                this.x = x; this.y = y; this.color = color; this.shape = shape;
                this.size = Math.random() * 4 + 1;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 100;
                this.decay = Math.random() * 0.5 + 0.5;
                this.gravity = 0.05;
                this.drag = 0.96;
                this.trail = []; // çƒŸèŠ±è½¨è¿¹ - å­˜å‚¨æ›´å¤šç‚¹
            }

            update() {
                //è®°å½•è½¨è¿¹ - å¢åŠ è½¨è¿¹ç‚¹æ•°é‡
                if (this.trail.length < 20) { // ä»10å¢åŠ åˆ°20
                    this.trail.push({x: this.x, y: this.y});
                } else {
                    this.trail.shift();
                    this.trail.push({x: this.x, y: this.y});
                }

                this.vx *= this.drag;
                this.vy *= this.drag;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                return this.life > 0;
            }

            draw(ctx) {
                // ç»˜åˆ¶è½¨è¿¹ - æ‹‰é•¿è½¨è¿¹æ•ˆæœ
                if (this.trail.length > 1) {
                    ctx.globalAlpha = this.life / 100 * 0.8; // å¢åŠ é€æ˜åº¦
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 2; // å¢åŠ çº¿æ¡å®½åº¦
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);

                    // ç»˜åˆ¶æ›´é•¿çš„è½¨è¿¹
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.stroke();
                }

                ctx.globalAlpha = this.life / 100;

                // æ ¹æ®å½¢çŠ¶ç»˜åˆ¶ä¸åŒæ•ˆæœ
                switch (this.shape) {
                    case 'heart':
                        this.drawHeart(ctx);
                        break;
                    case 'star':
                        this.drawStar(ctx);
                        break;
                    case 'spiral':
                        this.drawSpiral(ctx);
                        break;
                    case 'circle':
                        this.drawCircle(ctx);
                        break;
                    case 'diamond':
                        this.drawDiamond(ctx);
                        break;
                    case 'rainbow':
                        this.drawRainbow(ctx);
                        break;
                    case 'fire':
                        this.drawFire(ctx);
                        break;
                    case 'ice':
                        this.drawIce(ctx);
                        break;
                    case 'galaxy':
                        this.drawGalaxy(ctx);
                        break;
                    case 'neon':
                        this.drawNeon(ctx);
                        break;
                    default:
                        this.drawCircle(ctx);
                }

                ctx.globalAlpha = 1;
            }

            drawCircle(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
            }

            drawHeart(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                const s = this.size;
                ctx.moveTo(this.x, this.y);
                ctx.bezierCurveTo(this.x - s/2, this.y - s/2, this.x - s, this.y, this.x, this.y + s);
                ctx.bezierCurveTo(this.x + s, this.y, this.x + s/2, this.y - s/2, this.x, this.y);
                ctx.fill();
            }

            drawStar(ctx) {
                ctx.fillStyle = this.color;
                const spikes = 5;
                const outerRadius = this.size;
                const innerRadius = this.size / 2;
                const step = Math.PI / spikes;

                ctx.beginPath();
                ctx.moveTo(this.x, this.y - outerRadius);
                for (let i = 0; i < spikes; i++) {
                    const x = this.x + Math.cos(i * step) * outerRadius;
                    const y = this.y + Math.sin(i * step) * outerRadius;
                    ctx.lineTo(x, y);

                    const innerX = this.x + Math.cos((i + 0.5) * step) * innerRadius;
                    const innerY = this.y + Math.sin((i + 0.5) * step) * innerRadius;
                    ctx.lineTo(innerX, innerY);
                }
                ctx.closePath();
                ctx.fill();
            }

            drawSpiral(ctx) {
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                const turns = 2;
                for (let i = 0; i < 100; i++) {
                    const t = (i / 100) * turns * Math.PI * 2;
                    const r = (i / 100) * this.size * 2;
                    const x = this.x + r * Math.cos(t);
                    const y = this.y + r * Math.sin(t);
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            drawDiamond(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - this.size);
                ctx.lineTo(this.x + this.size, this.y);
                ctx.lineTo(this.x, this.y + this.size);
                ctx.lineTo(this.x - this.size, this.y);
                ctx.closePath();
                ctx.fill();
            }

            drawRainbow(ctx) {
                const colors = ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#9400D3'];
                const colorIndex = Math.floor((this.life / 100) * colors.length);
                ctx.fillStyle = colors[colorIndex % colors.length];
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }

            drawFire(ctx) {
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size);
                gradient.addColorStop(0, '#FFFF00');
                gradient.addColorStop(0.5, '#FFA500');
                gradient.addColorStop(1, '#FF4500');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }

            drawIce(ctx) {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - this.size);
                ctx.lineTo(this.x + this.size / 2, this.y);
                ctx.lineTo(this.x, this.y + this.size);
                ctx.lineTo(this.x - this.size / 2, this.y);
                ctx.closePath();
                ctx.fill();
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#00FFFF';
            }

            drawGalaxy(ctx) {
                const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 1.5);
                gradient.addColorStop(0, this.color);
                gradient.addColorStop(0.7, this.color + '80');
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size * 1.5, 0, Math.PI * 2);
                ctx.fill();
            }

            drawNeon(ctx) {
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 3;
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }

        // çƒŸèŠ±ç±»
        class Firework {
            constructor(sx, sy, tx, ty, type) {
                this.x = sx; this.y = sy; this.tx = tx; this.ty = ty; this.type = type;
                const dx = tx - sx; const dy = ty - sy;
                this.distance = Math.sqrt(dx * dx + dy * dy);
                this.angle = Math.atan2(dy, dx);
                this.speed = 2; this.acceleration = 1.05;
                this.targetRadius = 1;

                const typeConfig = fireworkTypes[type];
                const colors = typeConfig.colors;
                this.color = colors[Math.floor(Math.random() * colors.length)];
                this.shape = typeConfig.shape || 'circle';

                this.particles = [];
                const particleCount = Math.floor(Math.random() * 40) + 40; // å¢åŠ ç²’å­æ•°é‡
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push(new Particle(this.tx, this.ty, this.color, this.shape));
                }

                // å‘å°„è½¨è¿¹ - å¢åŠ è½¨è¿¹ç‚¹
                this.launchTrail = [];
            }

            update() {
                // è®°å½•å‘å°„è½¨è¿¹ - å¢åŠ è½¨è¿¹ç‚¹æ•°é‡
                if (this.launchTrail.length < 25) { // ä»15å¢åŠ åˆ°25
                    this.launchTrail.push({x: this.x, y: this.y});
                } else {
                    this.launchTrail.shift();
                    this.launchTrail.push({x: this.x, y: this.y});
                }

                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.speed *= this.acceleration;

                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 5 || this.speed > 15) {
                    // æ’­æ”¾çˆ†ç‚¸éŸ³æ•ˆ
                    playExplosionSound();
                    particles = particles.concat(this.particles);
                    return false;
                }
                return true;
            }

            draw(ctx) {
                // ç»˜åˆ¶å‘å°„è½¨è¿¹ - æ‹‰é•¿è½¨è¿¹
                if (this.launchTrail.length > 1) {
                    ctx.globalAlpha = 0.9; // å¢åŠ é€æ˜åº¦
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 3; // å¢åŠ çº¿æ¡å®½åº¦
                    ctx.beginPath();
                    ctx.moveTo(this.launchTrail[0].x, this.launchTrail[0].y);

                    // ç»˜åˆ¶æ›´é•¿çš„è½¨è¿¹
                    for (let i = 1; i < this.launchTrail.length; i++) {
                        ctx.lineTo(this.launchTrail[i].x, this.launchTrail[i].y);
                    }
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                }

                // ç»˜åˆ¶çƒŸèŠ±æœ¬ä½“
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                const tailX = this.x - Math.cos(this.angle) * 10;
                const tailY = this.y - Math.sin(this.angle) * 10;
                ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // ç»˜åˆ¶ç›®æ ‡ç‚¹
                ctx.beginPath();
                ctx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                ctx.fill();

                this.targetRadius += 0.3;
                if (this.targetRadius > 5) this.targetRadius = 1;
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMåŠ è½½å®Œæˆ');
            init();
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœè§†é¢‘
                if (video.srcObject) {
                    video.pause();
                }
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è§†é¢‘
                if (video.srcObject && cameraActive) {
                    video.play();
                }
            }
        });
    </script>
</body>
</html>

     
