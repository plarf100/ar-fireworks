<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a20">
    <title>ARçƒŸèŠ± - æ‰«ç æ”¾çƒŸèŠ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #0a0a20;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            text-align: center;
            padding: 12px 0;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        /* ARå®¹å™¨ */
        #ar-container {
            position: relative;
            flex: 1;
            background: linear-gradient(to bottom, #0c1445, #000);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ‘„åƒå¤´è§†é¢‘èƒŒæ™¯ */
        #camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1;
        }

        /* Canvasç”¨äºç»˜åˆ¶çƒŸèŠ± */
        #fireworks-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
        }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 20;
            font-size: 14px;
            text-shadow: 0 0 10px rgba(0, 200, 255, 0.7);
            padding: 0 20px;
            line-height: 1.5;
            background: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 0 20px;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: absolute;
            top: 60px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            z-index: 30;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #4cd964;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .status-indicator.error .status-dot {
            background: #ff3b30;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            background: rgba(10, 15, 30, 0.95);
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(0, 150, 255, 0.3);
            z-index: 100;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            border-radius: 50px;
            color: white;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 117, 252, 0.6);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2575fc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff3838);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
        }

        /* çƒŸèŠ±ç±»å‹é€‰æ‹©å™¨ */
        .firework-selector {
            display: flex;
            gap: 6px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 30px;
        }

        .firework-type {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            font-size: 12px;
        }

        .firework-type.active {
            border-color: white;
            transform: scale(1.1);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 20px;
        }

        .modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 340px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            color: #333;
        }

        .modal-box h2 {
            margin-bottom: 15px;
            color: #2575fc;
            font-size: 20px;
        }

        .modal-box p {
            margin-bottom: 15px;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }

        .modal-box .qr-placeholder {
            width: 180px;
            height: 180px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            border-radius: 10px;
        }

        .modal-box .qr-code {
            width: 180px;
            height: 180px;
            margin: 10px auto;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 13px;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            max-width: 85%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        /* é¦–æ¬¡å¼•å¯¼ */
        .onboarding {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            z-index: 50;
            max-width: 90%;
            width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .onboarding h3 {
            margin-bottom: 15px;
            color: #2575fc;
            font-size: 18px;
        }

        .onboarding p {
            font-size: 13px;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #555;
        }

        .onboarding .btn {
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }

        .onboarding .btn-outline {
            background: transparent;
            color: #2575fc;
            border: 2px solid #2575fc;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .header {
                font-size: 14px;
                padding: 10px 0;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .firework-type {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }

            .instruction {
                font-size: 12px;
                top: 15px;
                padding: 8px 15px;
                margin: 0 10px;
            }

            .status-indicator {
                top: 50px;
                font-size: 10px;
                padding: 5px 8px;
            }

            .onboarding {
                padding: 15px;
                width: 90%;
            }

            .modal-box {
                width: 90%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        âœ¨ ARçƒŸèŠ± - æ‰«ç æ”¾çƒŸèŠ±  âœ¨
    </div>

    <div id="ar-container">
        <video id="camera-video" autoplay playsinline muted></video>
        <canvas id="fireworks-canvas"></canvas>

        <div class="instruction" id="instruction-text">
            ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®å‘å°„çƒŸèŠ±<br>
            <small>é¦–æ¬¡ä½¿ç”¨éœ€è¦æˆæƒæ‘„åƒå¤´æƒé™</small>
        </div>

        <div class="status-indicator" id="status-indicator" style="display: none;">
            <div class="status-dot"></div>
            <span id="status-text">æ‘„åƒå¤´å·²å¯ç”¨</span>
        </div>

        <div class="onboarding" id="onboarding">
            <h3>ğŸ† ARçƒŸèŠ±ä½“éªŒæŒ‡å—</h3>
            <p>1. ç‚¹å‡»"å¼€å§‹ä½“éªŒ"æˆæƒæ‘„åƒå¤´æƒé™<br>
            2. å¯¹å‡†ä»»æ„åœºæ™¯ï¼Œç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±<br>
            3. å°è¯•ä¸åŒçƒŸèŠ±ç±»å‹å’Œé¢œè‰²<br>
            <br>
            <strong>å¦‚æœæ— æ³•è®¿é—®æ‘„åƒå¤´ï¼ŒçƒŸèŠ±æ•ˆæœä»å¯ä½¿ç”¨</strong></p>
            <button class="btn" id="start-btn">å¼€å§‹ä½“éªŒ ğŸ‰</button>
            <button class="btn btn-outline" id="skip-btn" style="margin-top: 8px;">è·³è¿‡æ‘„åƒå¤´</button>
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-outline btn-small" id="qr-btn">
            <span>ğŸ“±</span> åˆ†äº«
        </button>

        <div class="firework-selector">
            <div class="firework-type active" data-type="color" style="background: linear-gradient(45deg, red, yellow, blue);" title="å½©è‰²çƒŸèŠ±">ğŸŒˆ</div>
            <div class="firework-type" data-type="gold" style="background: linear-gradient(45deg, #FFD700, #FFA500);" title="é»„é‡‘çƒŸèŠ±">ğŸŒŸ</div>
            <div class="firework-type" data-type="purple" style="background: linear-gradient(45deg, #8A2BE2, #9370DB);" title="ç´«è‰²çƒŸèŠ±">ğŸ’œ</div>
            <div class="firework-type" data-type="heart" style="background: linear-gradient(45deg, #FF69B4, #FF1493);" title="çˆ±å¿ƒçƒŸèŠ±">â¤</div>
        </div>

        <button class="btn btn-danger btn-small" id="clear-btn">
            <span>ğŸ†</span> æ¸…é™¤
        </button>
    </div>

    <!-- åˆ†äº«æ¨¡æ€æ¡† -->
    <div class="modal" id="share-modal">
        <div class="modal-box">
            <h2>åˆ†äº«ARçƒŸèŠ±ä½“éªŒ</h2>
            <p>ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç <br>ä½“éªŒå¢å¼ºç°å®çƒŸèŠ±æ•ˆæœ</p>
            <div class="qr-placeholder" id="qr-placeholder">äºŒç»´ç å°†åœ¨æ­¤ç”Ÿæˆ</div>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">æˆªå›¾åˆ†äº«æˆ–ä¿å­˜äºŒç»´ç å›¾ç‰‡</p>
            <button class="btn" id="close-share">å…³é—­</button>
        </div>
    </div>

    <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
    <div class="modal" id="help-modal">
        <div class="modal-box">
            <h2>ä½¿ç”¨å¸®åŠ©</h2>
            <p><strong>æ‘„åƒå¤´é—®é¢˜è§£å†³ï¼š</strong></p>
            <p style="text-align: left; font-size: 12px;">
                1. ç¡®ä¿ä½¿ç”¨HTTPSè®¿é—®ï¼ˆhttp://localhosté™¤å¤–ï¼‰<br>
                2. æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®<br>
                3. å°è¯•ä½¿ç”¨"è·³è¿‡æ‘„åƒå¤´"æŒ‰é’®<br>
                4. æ›´æ–°æµè§ˆå™¨åˆ°æœ€æ–°ç‰ˆæœ¬
            </p>
            <p><strong>å°çº¢ä¹¦åˆ†äº«æŠ€å·§ï¼š</strong></p>
            <p style="text-align: left; font-size: 12px;">
                1. ç”ŸæˆäºŒç»´ç åæˆªå›¾<br>
                2. åœ¨å°çº¢ä¹¦ä¸­å‘å¸ƒå›¾æ–‡<br>
                3. ä½¿ç”¨è¯é¢˜æ ‡ç­¾ #ARçƒŸèŠ± #äº’åŠ¨ä½“éªŒ
            </p>
            <button class="btn" id="close-help">æ˜ç™½äº†</button>
        </div>
    </div>

    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // è·å–DOMå…ƒç´ 
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        const arContainer = document.getElementById('ar-container');
        const instructionText = document.getElementById('instruction-text');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const onboarding = document.getElementById('onboarding');
        const startBtn = document.getElementById('start-btn');
        const skipBtn = document.getElementById('skip-btn');
        const shareModal = document.getElementById('share-modal');
        const helpModal = document.getElementById('help-modal');
        const toast = document.getElementById('toast');
        const qrPlaceholder = document.getElementById('qr-placeholder');

        // çŠ¶æ€å˜é‡
        let cameraStream = null;
        let cameraActive = false;
        let fireworks = [];
        let particles = [];
        let lastClickTime = 0;
        let currentType = 'color';

        // çƒŸèŠ±ç±»å‹é…ç½®
        const fireworkTypes = {
            color: { colors: ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'], icon: 'ğŸŒˆ' },
            gold: { colors: ['#FFD700', '#FFA500', '#FF8C00', '#FF7800', '#FF6700', '#FFE4B5', '#F0E68C'], icon: 'ğŸŒŸ' },
            purple: { colors: ['#8A2BE2', '#9370DB', '#9932CC', '#BA55D3', '#DA70D6', '#EE82EE', '#DDA0DD'], icon: 'ğŸ’œ' },
            heart: { colors: ['#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB', '#FF69B4'], shape: 'heart', icon: 'â¤' }
        };

        // åˆå§‹åŒ–
        function init() {
            resizeCanvas();

            // äº‹ä»¶ç»‘å®š
            bindEvents();

            // åŠ¨ç”»å¾ªç¯
            requestAnimationFrame(animate);

            // æ˜¾ç¤ºå¸®åŠ©æç¤º
            setTimeout(() => {
                showToast('ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±ï¼Œå°è¯•ä¸åŒé¢œè‰²ï¼');
            }, 1000);
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', resizeCanvas);

            // å¼€å§‹æŒ‰é’®
            startBtn.addEventListener('click', startCamera);

            // è·³è¿‡æŒ‰é’®
            skipBtn.addEventListener('click', skipCamera);

            // Canvasç‚¹å‡»äº‹ä»¶
            canvas.addEventListener('click', handleCanvasClick);

            // çƒŸèŠ±ç±»å‹é€‰æ‹©
            document.querySelectorAll('.firework-type').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.firework-type').forEach(e => e.classList.remove('active'));
                    el.classList.add('active');
                    currentType = el.dataset.type;
                    showToast(`å·²åˆ‡æ¢åˆ°${fireworkTypes[currentType].icon} ${getFireworkTypeName(currentType)}`);
                });
            });

            // æ¸…é™¤æŒ‰é’®
            document.getElementById('clear-btn').addEventListener('click', clearFireworks);

            // åˆ†äº«æŒ‰é’®
            document.getElementById('qr-btn').addEventListener('click', showShareModal);
            document.getElementById('close-share').addEventListener('click', () => {
                shareModal.classList.remove('show');
            });

            // å¸®åŠ©æŒ‰é’®ï¼ˆåŒå‡»æ ‡é¢˜æ‰“å¼€å¸®åŠ©ï¼‰
            document.querySelector('.header').addEventListener('dblclick', () => {
                helpModal.classList.add('show');
            });
            document.getElementById('close-help').addEventListener('click', () => {
                helpModal.classList.remove('show');
            });
        }

        // è·å–çƒŸèŠ±ç±»å‹åç§°
        function getFireworkTypeName(type) {
            const names = {
                color: 'å½©è‰²çƒŸèŠ±',
                gold: 'é»„é‡‘çƒŸèŠ±',
                purple: 'ç´«è‰²çƒŸèŠ±',
                heart: 'çˆ±å¿ƒçƒŸèŠ±'
            };
            return names[type] || type;
        }

        // è°ƒæ•´Canvaså°ºå¯¸
        function resizeCanvas() {
            canvas.width = arContainer.clientWidth;
            canvas.height = arContainer.clientHeight;
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæ‘„åƒå¤´API
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼Œå·²è‡ªåŠ¨è·³è¿‡');
                    skipCamera();
                    return;
                }

                showToast('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...');

                // åœ¨iOSä¸Šï¼Œæ‘„åƒå¤´éœ€è¦ç”¨æˆ·æ‰‹åŠ¿è§¦å‘
                const constraints = {
                    video: {
                        facingMode: 'environment', // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;

                // ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆ
                video.onloadedmetadata = () => {
                    video.play();
                    cameraActive = true;
                    video.style.opacity = '1'; // æ˜¾ç¤ºè§†é¢‘

                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    statusIndicator.style.display = 'flex';
                    statusIndicator.classList.remove('error');
                    statusText.textContent = 'æ‘„åƒå¤´å·²å¯ç”¨';

                    // éšè—å¼•å¯¼
                    onboarding.style.display = 'none';

                    // æ›´æ–°æç¤ºæ–‡å­—
                    instructionText.innerHTML = 'ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®å‘å°„çƒŸèŠ±<br><small>å°è¯•ä¸åŒçƒŸèŠ±ç±»å‹å’Œé¢œè‰²</small>';

                    showToast('æ‘„åƒå¤´å·²å¯ç”¨ï¼Œå¯ä»¥å¼€å§‹æ”¾çƒŸèŠ±äº†ï¼');

                    // è‡ªåŠ¨å‘å°„å‡ ä¸ªçƒŸèŠ±ä½œä¸ºæ¼”ç¤º
                    setTimeout(autoDemoFireworks, 1500);
                };

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                cameraActive = false;

                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                statusIndicator.style.display = 'flex';
                statusIndicator.classList.add('error');
                statusText.textContent = 'æ‘„åƒå¤´æœªå¯ç”¨';

                // æ›´æ–°æç¤ºæ–‡å­—
                instructionText.innerHTML = 'ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®å‘å°„çƒŸèŠ±<br><small>æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œä½†çƒŸèŠ±æ•ˆæœä»å¯ç”¨</small>';

                showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œä½†çƒŸèŠ±æ•ˆæœä»å¯ç”¨');

                // éšè—å¼•å¯¼
                onboarding.style.display = 'none';
            }
        }

        // è·³è¿‡æ‘„åƒå¤´
        function skipCamera() {
            cameraActive = false;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            statusIndicator.style.display = 'flex';
            statusIndicator.classList.add('error');
            statusText.textContent = 'ä½¿ç”¨èƒŒæ™¯æ¨¡å¼';

            // æ›´æ–°æç¤ºæ–‡å­—
            instructionText.innerHTML = 'ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®å‘å°„çƒŸèŠ±<br><small>ä½¿ç”¨èƒŒæ™¯æ¨¡å¼ï¼Œæ— æ‘„åƒå¤´æ•ˆæœ</small>';

            showToast('å·²è·³è¿‡æ‘„åƒå¤´ï¼Œä½¿ç”¨èƒŒæ™¯æ¨¡å¼');

            // éšè—å¼•å¯¼
            onboarding.style.display = 'none';

            // è‡ªåŠ¨å‘å°„çƒŸèŠ±æ¼”ç¤º
            setTimeout(autoDemoFireworks, 1000);
        }

        // å¤„ç†Canvasç‚¹å‡»
        function handleCanvasClick(e) {
            const now = Date.now();
            if (now - lastClickTime < 300) return; // é˜²æ­¢è¿ç»­ç‚¹å‡»
            lastClickTime = now;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // åœ¨åº•éƒ¨éšæœºä½ç½®å‘å°„
            const startX = Math.random() * canvas.width;
            const startY = canvas.height;

            // åˆ›å»ºçƒŸèŠ±
            const firework = new Firework(startX, startY, x, y, currentType);
            fireworks.push(firework);
        }

        // è‡ªåŠ¨æ¼”ç¤ºçƒŸèŠ±
        function autoDemoFireworks() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 3;

            // ä¾æ¬¡å‘å°„ä¸åŒç±»å‹çš„çƒŸèŠ±
            setTimeout(() => {
                fireworks.push(new Firework(centerX - 80, canvas.height, centerX - 80, centerY, 'gold'));
            }, 500);

            setTimeout(() => {
                fireworks.push(new Firework(centerX, canvas.height, centerX, centerY, 'color'));
            }, 1000);

            setTimeout(() => {
                fireworks.push(new Firework(centerX + 80, canvas.height, centerX + 80, centerY, 'purple'));
            }, 1500);

            setTimeout(() => {
                fireworks.push(new Firework(centerX, canvas.height, centerX, centerY + 50, 'heart'));
            }, 2000);
        }

        // æ¸…é™¤æ‰€æœ‰çƒŸèŠ±
        function clearFireworks() {
            fireworks = [];
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('çƒŸèŠ±å·²æ¸…é™¤');
        }

        // æ˜¾ç¤ºåˆ†äº«æ¨¡æ€æ¡†
        function showShareModal() {
            shareModal.classList.add('show');

            // ç”ŸæˆäºŒç»´ç å›¾ç‰‡ï¼ˆè¿™é‡Œä½¿ç”¨emojiæ¨¡æ‹Ÿï¼Œå®é™…é¡¹ç›®ä¸­åº”ç”ŸæˆçœŸå®äºŒç»´ç ï¼‰
            const currentUrl = window.location.href;
            const qrEmoji = 'ğŸ†';

            qrPlaceholder.innerHTML = `
                <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 48px; margin-bottom: 10px;">${qrEmoji}</div>
                    <div style="font-weight: bold; color: #333;">ARçƒŸèŠ±ä½“éªŒ</div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æ</div>
                </div>
            `;

            showToast('æˆªå›¾åˆ†äº«ç»™æœ‹å‹ï¼Œæˆ–ä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«');
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, color, shape = 'circle') {
                this.x = x;
                this.y = y;
                this.color = color;
                this.shape = shape;
                this.size = Math.random() * 4 + 1;

                // éšæœºé€Ÿåº¦
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;

                this.life = 100; // ç”Ÿå‘½å€¼
                this.decay = Math.random() * 0.5 + 0.5; // è¡°å‡é€Ÿåº¦
                this.gravity = 0.05; // é‡åŠ›
                this.drag = 0.96; // é˜»åŠ›
            }

            update() {
                this.vx *= this.drag;
                this.vy *= this.drag;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                return this.life > 0;
            }

            draw(ctx) {
                ctx.globalAlpha = this.life / 100;

                if (this.shape === 'heart') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    const size = this.size;
                    ctx.moveTo(this.x, this.y);
                    ctx.bezierCurveTo(
                        this.x - size/2, this.y - size/2,
                        this.x - size, this.y,
                        this.x, this.y + size
                    );
                    ctx.bezierCurveTo(
                        this.x + size, this.y,
                        this.x + size/2, this.y - size/2,
                        this.x, this.y
                    );
                    ctx.fill();
                } else {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();

                    // æ·»åŠ å‘å…‰æ•ˆæœ
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.color;
                }

                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }
        }

        // çƒŸèŠ±ç±»
        class Firework {
            constructor(sx, sy, tx, ty, type) {
                this.x = sx;
                this.y = sy;
                this.tx = tx;
                this.ty = ty;
                this.type = type;

                // è®¡ç®—è·ç¦»å’Œè§’åº¦
                const dx = tx - sx;
                const dy = ty - sy;
                this.distance = Math.sqrt(dx * dx + dy * dy);
                this.angle = Math.atan2(dy, dx);

                this.speed = 2;
                this.acceleration = 1.05;
                this.brightness = Math.random() * 50 + 50;
                this.targetRadius = 1;

                // éšæœºé¢œè‰²
                const colors = fireworkTypes[type].colors;
                this.color = colors[Math.floor(Math.random() * colors.length)];

                // åˆ›å»ºç²’å­
                this.particles = [];
                const particleCount = Math.floor(Math.random() * 30) + 30;
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push(new Particle(this.tx, this.ty, this.color, fireworkTypes[type].shape));
                }
            }

            update() {
                // æ›´æ–°ä½ç½®
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;

                // åŠ é€Ÿ
                this.speed *= this.acceleration;

                // æ£€æŸ¥æ˜¯å¦åˆ°è¾¾ç›®æ ‡ä½ç½®
                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                // å¦‚æœæ¥è¿‘ç›®æ ‡ä½ç½®æˆ–è¶…è¿‡ï¼Œåˆ™çˆ†ç‚¸
                if (dist < 5 || this.speed > 15) {
                    this.explode();
                    return false;
                }

                return true;
            }

            draw(ctx) {
                // ç»˜åˆ¶è½¨è¿¹
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                const tailX = this.x - Math.cos(this.angle) * 10;
                const tailY = this.y - Math.sin(this.angle) * 10;
                ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // ç»˜åˆ¶ç›®æ ‡ç‚¹
                ctx.beginPath();
                ctx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                ctx.fill();

                // ç›®æ ‡ç‚¹é—ªçƒæ•ˆæœ
                this.targetRadius += 0.3;
                if (this.targetRadius > 5) {
                    this.targetRadius = 1;
                }
            }

            explode() {
                // æ·»åŠ çˆ†ç‚¸ç²’å­åˆ°å…¨å±€ç²’å­æ•°ç»„
                particles = particles.concat(this.particles);
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            // åˆ›å»ºåŠé€æ˜èƒŒæ™¯å®ç°æ‹–å°¾æ•ˆæœ
            ctx.fillStyle = 'rgba(0, 0, 10, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const firework = fireworks[i];
                if (!firework.update()) {
                    fireworks.splice(i, 1);
                } else {
                    firework.draw(ctx);
                }
            }

            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                if (!particle.update()) {
                    particles.splice(i, 1);
                } else {
                    particle.draw(ctx);
                }
            }

            requestAnimationFrame(animate);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // æ·»åŠ ä¸€äº›é¢å¤–çš„ç”¨æˆ·æç¤º
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœè§†é¢‘
                if (video.srcObject) {
                    video.pause();
                }
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è§†é¢‘
                if (video.srcObject && cameraActive) {
                    video.play();
                }
            }
        });
    </script>
</body>
</html>
