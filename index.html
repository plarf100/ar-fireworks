<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARçƒŸèŠ± - çº¯æ‘„åƒå¤´ä½“éªŒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: #fff; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* é¡¶éƒ¨æ ‡é¢˜ */
        .header {
            text-align: center;
            padding: 10px;
            background: linear-gradient(to right, #6a11cb, #2575fc);
            font-weight: bold;
            font-size: 16px;
            z-index: 100;
        }

        /* æ‘„åƒå¤´å®¹å™¨ */
        #camera-container {
            position: relative;
            flex: 1;
            background: #000;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* æ‘„åƒå¤´è§†é¢‘ */
        #camera-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ */
            z-index: 1;
            display: none; /* åˆå§‹éšè— */
        }

        /* çƒŸèŠ±Canvas - å¿…é¡»æ”¾åœ¨æœ€ä¸Šå±‚ */
        #fireworks-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            cursor: crosshair;
            pointer-events: auto; /* ç¡®ä¿èƒ½æ¥æ”¶ç‚¹å‡» */
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: absolute;
            top: 60px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 20;
            display: none;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4cd964;
            display: inline-block;
            margin-right: 5px;
            animation: blink 1s infinite;
        }

        .status-dot.error {
            background: #ff3b30;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            z-index: 20;
            border-radius: 8px;
            margin: 0 15px;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls {
            background: rgba(10, 15, 30, 0.95);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            z-index: 100;
        }

        .btn {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #2575fc;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ff3838);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 11px;
        }

        /* çƒŸèŠ±ç±»å‹é€‰æ‹©å™¨ */
        .firework-selector {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 3px;
            border-radius: 15px;
        }

        .firework-type {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 10px;
        }

        .firework-type.active {
            border-color: white;
            transform: scale(1.1);
        }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
            text-align: center;
            max-width: 80%;
        }

        .toast.show {
            opacity: 1;
        }

        /* å¼•å¯¼ç•Œé¢ */
        .onboarding {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            z-index: 50;
        }

        .onboarding h3 {
            margin-bottom: 10px;
            color: #2575fc;
        }

        .onboarding p {
            font-size: 12px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .onboarding .btn {
            width: 100%;
            margin-bottom: 8px;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            z-index: 5;
            display: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #2575fc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* äºŒç»´ç æç¤º */
        .qr-hint {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 11px;
            z-index: 15;
            display: none;
            text-align: center;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .header { font-size: 14px; padding: 8px; }
            .btn { padding: 6px 10px; font-size: 11px; }
            .firework-type { width: 24px; height: 24px; font-size: 9px; }
            .instruction { font-size: 12px; top: 15px; padding: 8px; }
            .onboarding { padding: 12px; width: 90%; }
            .status-indicator { top: 50px; font-size: 11px; padding: 5px 10px; }
        }
    </style>
</head>
<body>
    <div class="header">âœ¨ ARçƒŸèŠ± - ç‚¹å‡»æ”¾çƒŸèŠ± âœ¨</div>

    <div id="camera-container">
        <!-- æ‘„åƒå¤´è§†é¢‘ -->
        <video id="camera-video" autoplay playsinline muted webkit-playsinline></video>

        <!-- çƒŸèŠ±Canvas -->
        <canvas id="fireworks-canvas"></canvas>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status-indicator" id="status-indicator">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">ç­‰å¾…å¯åŠ¨...</span>
        </div>

        <!-- æç¤ºæ–‡å­— -->
        <div class="instruction" id="instruction-text">
            ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹<br>
            <small>æˆ–ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±ï¼ˆæ— éœ€æ‘„åƒå¤´ï¼‰</small>
        </div>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div id="loading-text">æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...</div>
        </div>

        <!-- å¼•å¯¼ç•Œé¢ -->
        <div class="onboarding" id="onboarding">
            <h3>ğŸ† ARçƒŸèŠ±ä½“éªŒ</h3>
            <p>1. ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"æˆæƒæƒé™<br>
            2. æ‘„åƒå¤´ç”»é¢å°†æ˜¾ç¤ºåœ¨èƒŒæ™¯<br>
            3. ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ”¾çƒŸèŠ±<br>
            4. çƒŸèŠ±ä¼šå åŠ åœ¨å®æ™¯ç”»é¢ä¸Š</p>
            <button class="btn" id="start-btn">å¯åŠ¨æ‘„åƒå¤´</button>
            <button class="btn btn-outline" id="skip-btn">è·³è¿‡æ‘„åƒå¤´</button>
        </div>

        <!-- äºŒç»´ç æç¤º -->
        <div class="qr-hint" id="qr-hint">
            é•¿æŒ‰äºŒç»´ç  â†’ è¯†åˆ«å›¾ä¸­äºŒç»´ç 
        </div>
    </div>

    <div class="controls">
        <button class="btn btn-outline btn-small" id="qr-btn">ğŸ“± åˆ†äº«</button>

        <div class="firework-selector">
            <div class="firework-type active" data-type="color" style="background: linear-gradient(45deg, red, yellow, blue);" title="å½©è‰²çƒŸèŠ±">ğŸŒˆ</div>
            <div class="firework-type" data-type="gold" style="background: linear-gradient(45deg, #FFD700, #FFA500);" title="é»„é‡‘çƒŸèŠ±">ğŸŒŸ</div>
            <div class="firework-type" data-type="purple" style="background: linear-gradient(45deg, #8A2BE2, #9370DB);" title="ç´«è‰²çƒŸèŠ±">ğŸ’œ</div>
            <div class="firework-type" data-type="heart" style="background: linear-gradient(45deg, #FF69B4, #FF1493);" title="çˆ±å¿ƒçƒŸèŠ±">â¤</div>
        </div>

        <button class="btn btn-danger btn-small" id="clear-btn">ğŸ† æ¸…é™¤</button>
    </div>

    <!-- æç¤ºæ¡† -->
    <div class="toast" id="toast">æç¤ºä¿¡æ¯</div>

    <script>
        // è·å–DOMå…ƒç´ 
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('camera-container');
        const instruction = document.getElementById('instruction-text');
        const statusIndicator = document.getElementById('status-indicator');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const onboarding = document.getElementById('onboarding');
        const startBtn = document.getElementById('start-btn');
        const skipBtn = document.getElementById('skip-btn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const toast = document.getElementById('toast');
        const qrBtn = document.getElementById('qr-btn');
        const clearBtn = document.getElementById('clear-btn');
        const qrHint = document.getElementById('qr-hint');

        // çŠ¶æ€å˜é‡
        let cameraActive = false;
        let cameraStream = null;
        let fireworks = [];
        let particles = [];
        let lastClickTime = 0;
        let currentType = 'color';

        // çƒŸèŠ±ç±»å‹é…ç½®
        const fireworkTypes = {
            color: { colors: ['#FF5252', '#FF4081', '#E040FB', '#7C4DFF', '#536DFE', '#448AFF', '#40C4FF', '#18FFFF', '#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41', '#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'] },
            gold: { colors: ['#FFD700', '#FFA500', '#FF8C00', '#FF7800', '#FF6700', '#FFE4B5', '#F0E68C'] },
            purple: { colors: ['#8A2BE2', '#9370DB', '#9932CC', '#BA55D3', '#DA70D6', '#EE82EE', '#DDA0DD'] },
            heart: { colors: ['#FF69B4', '#FF1493', '#FFB6C1', '#FFC0CB', '#FF69B4'], shape: 'heart' }
        };

        // åˆå§‹åŒ–
        function init() {
            resizeCanvas();
            bindEvents();
            requestAnimationFrame(animateFireworks);
            showToast('ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±ï¼');
        }

        // è°ƒæ•´Canvaså°ºå¯¸
        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            window.addEventListener('resize', resizeCanvas);

            // å¼€å§‹æ‘„åƒå¤´
            startBtn.addEventListener('click', startCamera);

            // è·³è¿‡æ‘„åƒå¤´
            skipBtn.addEventListener('click', skipCamera);

            // Canvasç‚¹å‡»äº‹ä»¶ - å…³é”®ä¿®å¤
            canvas.addEventListener('click', handleCanvasClick);
            // å…¼å®¹è§¦æ‘¸äº‹ä»¶
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });

            // çƒŸèŠ±ç±»å‹é€‰æ‹©
            document.querySelectorAll('.firework-type').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.firework-type').forEach(e => e.classList.remove('active'));
                    el.classList.add('active');
                    currentType = el.dataset.type;
                    const names = {color:'å½©è‰²', gold:'é»„é‡‘', purple:'ç´«è‰²', heart:'çˆ±å¿ƒ'};
                    showToast(`å·²åˆ‡æ¢åˆ°${names[currentType]}çƒŸèŠ±`);
                });
            });

            // æ¸…é™¤æŒ‰é’®
            clearBtn.addEventListener('click', clearFireworks);

            // åˆ†äº«æŒ‰é’®
            qrBtn.addEventListener('click', showShare);

            // éšè—äºŒç»´ç æç¤º
            setTimeout(() => {
                qrHint.style.display = 'block';
                setTimeout(() => {
                    qrHint.style.display = 'none';
                }, 3000);
            }, 2000);
        }

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.style.display = 'block';
            loadingText.textContent = 'æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...';
            statusIndicator.style.display = 'flex';
            statusText.textContent = 'æ­£åœ¨å¯åŠ¨...';

            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½');
                }

                // è¯·æ±‚æ‘„åƒå¤´æƒé™
                const constraints = {
                    video: {
                        facingMode: 'environment', // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 }
                    },
                    audio: false
                };

                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = cameraStream;

                // ç­‰å¾…è§†é¢‘åŠ è½½
                video.onloadedmetadata = async () => {
                    try {
                        // å°è¯•æ’­æ”¾è§†é¢‘
                        await video.play();

                        // æˆåŠŸï¼æ˜¾ç¤ºè§†é¢‘
                        video.style.display = 'block';
                        cameraActive = true;

                        // æ›´æ–°UI
                        loading.style.display = 'none';
                        statusDot.classList.remove('error');
                        statusText.textContent = 'æ‘„åƒå¤´å·²å¯ç”¨';
                        instruction.innerHTML = 'ç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ”¾çƒŸèŠ±<br><small>çƒŸèŠ±å°†å åŠ åœ¨å®æ™¯ç”»é¢ä¸Š</small>';
                        onboarding.style.display = 'none';

                        showToast('æ‘„åƒå¤´å·²å¯ç”¨ï¼ç°åœ¨ç‚¹å‡»å±å¹•æ”¾çƒŸèŠ±');

                    } catch (playError) {
                        throw new Error('æ‘„åƒå¤´æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™');
                    }
                };

            } catch (error) {
                console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
                // æ›´æ–°UIæ˜¾ç¤ºé”™è¯¯
                loading.style.display = 'none';
                statusDot.classList.add('error');
                statusText.textContent = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥';

                // æ ¹æ®é”™è¯¯ç±»å‹ç»™å‡ºä¸åŒæç¤º
                let errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥';
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ‘„åƒå¤´';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥';
                } else {
                    errorMessage = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œä½†çƒŸèŠ±æ•ˆæœä»å¯ä½¿ç”¨';
                }

                showToast(errorMessage);

                // 2ç§’åè‡ªåŠ¨è·³è¿‡
                setTimeout(() => {
                    if (!cameraActive) {
                        skipCamera();
                    }
                }, 2000);
            }
        }

        // è·³è¿‡æ‘„åƒå¤´
        function skipCamera() {
            cameraActive = false;
            loading.style.display = 'none';
            statusDot.classList.add('error');
            statusText.textContent = 'ä½¿ç”¨èƒŒæ™¯æ¨¡å¼';
            instruction.innerHTML = 'ç‚¹å‡»å±å¹•å‘å°„çƒŸèŠ±<br><small>ä½¿ç”¨èƒŒæ™¯æ¨¡å¼</small>';
            onboarding.style.display = 'none';
            showToast('å·²è·³è¿‡æ‘„åƒå¤´ï¼Œä½¿ç”¨èƒŒæ™¯æ¨¡å¼');
        }

        // å¤„ç†Canvasç‚¹å‡» - å…³é”®ä¿®å¤
        function handleCanvasClick(e) {
            const now = Date.now();
            if (now - lastClickTime < 300) return; // é˜²æ­¢è¿ç»­ç‚¹å‡»
            lastClickTime = now;

            // è·å–ç‚¹å‡»ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // å‘å°„çƒŸèŠ±
           å‘å°„çƒŸèŠ±(x, y);
        }

        // å¤„ç†è§¦æ‘¸äº‹ä»¶
        function handleTouchStart(e) {
            e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨

            const now = Date.now();
            if (now - lastClickTime < 300) return; // é˜²æ­¢è¿ç»­ç‚¹å‡»
            lastClickTime = now;

            // è·å–è§¦æ‘¸ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;

            // å‘å°„çƒŸèŠ±
           å‘å°„çƒŸèŠ±(x, y);
        }

        // å‘å°„çƒŸèŠ±
        functionå‘å°„çƒŸèŠ±(x, y) {
            const startX = Math.random() * canvas.width;
            const startY = canvas.height;

            const firework = new Firework(startX, startY, x, y, currentType);
            fireworks.push(firework);

            showToast('çƒŸèŠ±å·²å‘å°„ï¼');
        }

        // æ¸…é™¤çƒŸèŠ±
        function clearFireworks() {
            fireworks = [];
            particles = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            showToast('çƒŸèŠ±å·²æ¸…é™¤');
        }

        // æ˜¾ç¤ºåˆ†äº«
        function showShare() {
            // ç”Ÿæˆå½“å‰é¡µé¢çš„äºŒç»´ç 
            const currentUrl = window.location.href;
            const qrEmoji = 'ğŸ†';

            const qrModal = document.createElement('div');
            qrModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 200;
            `;

            qrModal.innerHTML = `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; width: 300px;">
                    <h2 style="margin: 0 0 15px 0; color: #2575fc;">åˆ†äº«ARçƒŸèŠ±</h2>
                    <div style="width: 200px; height: 200px; background: linear-gradient(45deg, #6a11cb, #2575fc); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                        ${qrEmoji}
                    </div>
                    <p style="margin: 0 0 15px 0; font-size: 12px; color: #666;">é•¿æŒ‰äºŒç»´ç ä¿å­˜æˆ–åˆ†äº«</p>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: #2575fc; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer;">å…³é—­</button>
                </div>
            `;

            document.body.appendChild(qrModal);

            showToast('æˆªå›¾åˆ†äº«ç»™æœ‹å‹ï¼');
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // çƒŸèŠ±æ¸²æŸ“å¾ªç¯
        function animateFireworks() {
            // åˆ›å»ºåŠé€æ˜èƒŒæ™¯å®ç°æ‹–å°¾æ•ˆæœ
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const firework = fireworks[i];
                if (!firework.update()) {
                    fireworks.splice(i, 1);
                } else {
                    firework.draw(ctx);
                }
            }

            // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
            for (let i = particles.length - 1; i >= 0; i--) {
                const particle = particles[i];
                if (!particle.update()) {
                    particles.splice(i, 1);
                } else {
                    particle.draw(ctx);
                }
            }

            requestAnimationFrame(animateFireworks);
        }

        // ç²’å­ç±»
        class Particle {
            constructor(x, y, color, shape = 'circle') {
                this.x = x; this.y = y; this.color = color; this.shape = shape;
                this.size = Math.random() * 4 + 1;
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 100;
                this.decay = Math.random() * 0.5 + 0.5;
                this.gravity = 0.05;
                this.drag = 0.96;
            }

            update() {
                this.vx *= this.drag;
                this.vy *= this.drag;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                return this.life > 0;
            }

            draw(ctx) {
                ctx.globalAlpha = this.life / 100;
                if (this.shape === 'heart') {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    const s = this.size;
                    ctx.moveTo(this.x, this.y);
                    ctx.bezierCurveTo(this.x - s/2, this.y - s/2, this.x - s, this.y, this.x, this.y + s);
                    ctx.bezierCurveTo(this.x + s, this.y, this.x + s/2, this.y - s/2, this.x, this.y);
                    ctx.fill();
                } else {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = this.color;
                }
                ctx.globalAlpha = 1;
                ctx.shadowBlur = 0;
            }
        }

        // çƒŸèŠ±ç±»
        class Firework {
            constructor(sx, sy, tx, ty, type) {
                this.x = sx; this.y = sy; this.tx = tx; this.ty = ty; this.type = type;
                const dx = tx - sx; const dy = ty - sy;
                this.distance = Math.sqrt(dx * dx + dy * dy);
                this.angle = Math.atan2(dy, dx);
                this.speed = 2; this.acceleration = 1.05;
                this.targetRadius = 1;

                const colors = fireworkTypes[type].colors;
                this.color = colors[Math.floor(Math.random() * colors.length)];

                this.particles = [];
                const particleCount = Math.floor(Math.random() * 30) + 30;
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push(new Particle(this.tx, this.ty, this.color, fireworkTypes[type].shape));
                }
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                this.speed *= this.acceleration;

                const dx = this.tx - this.x;
                const dy = this.ty - this.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                if (dist < 5 || this.speed > 15) {
                    particles = particles.concat(this.particles);
                    return false;
                }
                return true;
            }

            draw(ctx) {
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                const tailX = this.x - Math.cos(this.angle) * 10;
                const tailY = this.y - Math.sin(this.angle) * 10;
                ctx.lineTo(tailX, tailY);
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.beginPath();
                ctx.arc(this.tx, this.ty, this.targetRadius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                ctx.fill();

                this.targetRadius += 0.3;
                if (this.targetRadius > 5) this.targetRadius = 1;
            }
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', init);

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶æš‚åœè§†é¢‘
                if (video.srcObject) {
                    video.pause();
                }
            } else {
                // é¡µé¢æ˜¾ç¤ºæ—¶æ¢å¤è§†é¢‘
                if (video.srcObject && cameraActive) {
                    video.play();
                }
            }
        });
    </script>
</body>
</html>


     
